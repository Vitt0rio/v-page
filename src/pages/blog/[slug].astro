---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const { slug } = Astro.params;

const posts = await getCollection('blog');
const post = posts.find((p) => p.slug === slug);

if (!post) throw new Error("Post no encontrado");

const { Content } = await post.render();
---

<BaseLayout title={post.data.title}>

<div id="__post_slug" data-slug={slug}></div>

  <div class="post-container">
    <h1 class="post-title">{post.data.title}</h1>
    <div class="post-date">{post.data.date.toDateString()}</div>

    <div class="post-content">
      <Content />
    </div>
  </div>

  <button class="comments-toggle" id="openComments">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span>Comentarios</span>
  </button>

  <div class="overlay" id="overlay"></div>

  <aside class="comments-panel" id="commentsPanel">

    <div class="panel-header">
      <div class="header-content">
        <h3>Comentarios</h3>
        <span class="comment-count" id="commentCount">0</span>
      </div>
      <button id="closeComments" class="close-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <details class="admin-panel">
      <summary class="admin-toggle">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        <span>Modo Admin</span>
        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </summary>
      <div class="admin-content">
        <input
          type="password"
          id="admin-code"
          placeholder="Ingresa el c贸digo admin"
        />
      </div>
    </details>

    <form id="comment-form" class="comment-form">
      <div class="form-header">
        <span class="form-title">Nuevo comentario</span>
      </div>
      
      <textarea
        id="comment-content"
        placeholder="Comparte tu opini贸n..."
        required
        rows="4"
        maxlength="1000"
      ></textarea>

      <div class="char-count" id="charCount">0/1000</div>

      <div class="form-bottom">
        <input
          type="text"
          id="comment-name"
          placeholder="Tu nombre (opcional)"
          maxlength="50"
        />
         <input
           type="text"
           name="website"
           id="comment-website"
           style="display:none"
           autocomplete="off"
           tabindex="-1"
        />

        <button type="submit" class="submit-btn" id="submitBtn">
          <span>Publicar</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>

      <div class="error-message" id="errorMessage"></div>
    </form>

    <div class="comments-divider"></div>

    <!-- Loading state -->
    <div class="loading-state" id="loadingState">
      <div class="spinner"></div>
      <p>Cargando comentarios...</p>
    </div>

    <div id="comments-list" class="comments-list"></div>

    <div class="empty-state" id="emptyState">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <p>A煤n no hay comentarios</p>
      <span>S茅 el primero en compartir tu opini贸n</span>
    </div>

  </aside>

  <style>
    * {
      box-sizing: border-box;
    }

    .post-container {
      max-width: 900px;
      margin: 140px auto;
      padding: 0 40px;
      line-height: 2;
    }

    .post-date {
      font-size: 0.75em;
      color: #555;
      margin-bottom: 40px;
    }

    /* ========== BOTN FLOTANTE ========== */
    .comments-toggle {
      position: fixed;
      bottom: 40px;
      right: 40px;
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 14px 24px;
      border-radius: 50px;
      font-size: 0.85em;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .comments-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .comments-toggle svg {
      transition: transform 0.3s;
    }

    .comments-toggle:hover svg {
      transform: scale(1.1);
    }

    /* ========== OVERLAY ========== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1001;
    }

    .overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* ========== PANEL DE COMENTARIOS ========== */
    .comments-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 480px;
      height: 100vh;
      background: linear-gradient(180deg, #0f0f0f 0%, #0a0a0a 100%);
      border-left: 1px solid rgba(255, 255, 255, 0.05);
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.22, 0.61, 0.36, 1);
      padding: 0;
      overflow-y: auto;
      z-index: 1002;
      display: flex;
      flex-direction: column;
    }

    .comments-panel.active {
      transform: translateX(0);
    }

    .comments-panel::-webkit-scrollbar {
      width: 8px;
    }

    .comments-panel::-webkit-scrollbar-track {
      background: transparent;
    }

    .comments-panel::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .comments-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* ========== HEADER ========== */
    .panel-header {
      position: sticky;
      top: 0;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(20px);
      padding: 32px 32px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      z-index: 10;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-content h3 {
      margin: 0;
      font-size: 1.2em;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: -0.02em;
    }

    .comment-count {
      background: rgba(255, 255, 255, 0.08);
      color: #999;
      font-size: 0.75em;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .close-btn {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
    }

    /* ========== PANEL ADMIN ========== */
    .admin-panel {
      margin: 0 32px;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .admin-panel[open] {
      padding-bottom: 20px;
    }

    .admin-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 0.8em;
      color: #666;
      list-style: none;
    }

    .admin-toggle:hover {
      background: rgba(255, 255, 255, 0.03);
      color: #888;
    }

    .admin-toggle::-webkit-details-marker {
      display: none;
    }

    .admin-toggle .chevron {
      margin-left: auto;
      transition: transform 0.2s;
    }

    .admin-panel[open] .admin-toggle .chevron {
      transform: rotate(180deg);
    }

    .admin-content {
      padding: 12px 12px 0;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .admin-content input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 10px 14px;
      color: #888;
      font-size: 0.85em;
      transition: all 0.2s;
    }

    .admin-content input:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.15);
      color: #aaa;
    }

    .admin-content input::placeholder {
      color: #555;
    }

    /* ========== FORMULARIO ========== */
    .comment-form {
      padding: 24px 32px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .form-header {
      margin-bottom: 12px;
    }

    .form-title {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #666;
      font-weight: 600;
    }

    .comment-form textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 14px 16px;
      color: white;
      resize: vertical;
      font-size: 0.9em;
      font-family: inherit;
      line-height: 1.6;
      transition: all 0.2s;
      min-height: 100px;
    }

    .comment-form textarea:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .comment-form textarea::placeholder {
      color: #555;
    }

    .char-count {
      font-size: 0.7em;
      color: #555;
      text-align: right;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .form-bottom {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .form-bottom input {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 12px 16px;
      color: #aaa;
      font-size: 0.85em;
      transition: all 0.2s;
    }

    .form-bottom input:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.15);
      color: #ddd;
    }

    .submit-btn {
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
      border: none;
      color: #000;
      padding: 12px 24px;
      font-size: 0.85em;
      font-weight: 600;
      cursor: pointer;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.8em;
      margin-top: 8px;
      display: none;
    }

    .error-message.visible {
      display: block;
    }

    /* ========== DIVISOR ========== */
    .comments-divider {
      height: 1px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.1) 50%, 
        transparent 100%
      );
      margin: 0 32px;
    }

    /* ========== LOADING STATE ========== */
    .loading-state {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 32px;
      gap: 16px;
    }

    .loading-state.visible {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-state p {
      color: #666;
      font-size: 0.9em;
    }

    /* ========== LISTA DE COMENTARIOS ========== */
    .comments-list {
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      flex: 1;
    }

    .comment-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s;
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .comment-item:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .comment-name {
      font-size: 0.85em;
      font-weight: 600;
      color: #f0f0f0;
      margin-bottom: 6px;
    }

    .comment-text {
      font-size: 0.8em;
      font-weight: 300;
      line-height: 1.6;
      color: #b0b0b0;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 8px;
    }

    .comment-date {
      font-size: 0.65em;
      font-weight: 300;
      color: #4a4a4a;
      opacity: 0.7;
    }

    .delete-btn {
      font-size: 0.7em;
      color: #555;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
      align-self: flex-start;
      margin-top: 4px;
      border: none;
      background: transparent;
    }

    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    /* ========== ESTADO VACO ========== */
    .empty-state {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 32px;
      text-align: center;
      color: #666;
      gap: 12px;
    }

    .empty-state.visible {
      display: flex;
    }

    .empty-state svg {
      opacity: 0.3;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 1em;
      font-weight: 600;
      color: #888;
      margin: 0;
    }

    .empty-state span {
      font-size: 0.85em;
      color: #555;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .comments-panel {
        width: 100%;
      }

      .comments-toggle {
        bottom: 24px;
        right: 24px;
        padding: 12px 20px;
        font-size: 0.8em;
      }

      .panel-header,
      .admin-panel,
      .comment-form,
      .comments-list {
        padding-left: 24px;
        padding-right: 24px;
      }
    }
  </style>

  <script is:inline>
    function initCommentsSystem() {
      const panel = document.getElementById("commentsPanel");
      const overlay = document.getElementById("overlay");
      const adminInput = document.getElementById("admin-code");
      const commentCount = document.getElementById("commentCount");
      const emptyState = document.getElementById("emptyState");
      const loadingState = document.getElementById("loadingState");
      const commentsList = document.getElementById("comments-list");
      const openBtn = document.getElementById("openComments");
      const closeBtn = document.getElementById("closeComments");
      const form = document.getElementById("comment-form");
      const contentInput = document.getElementById("comment-content");
      const charCount = document.getElementById("charCount");
      const errorMessage = document.getElementById("errorMessage");

      if (!panel || !openBtn) return;

      let isAdmin = false;

      // Character counter
      contentInput?.addEventListener("input", () => {
        const length = contentInput.value.length;
        charCount.textContent = `${length}/1000`;
        
        if (length > 900) {
          charCount.style.color = "#ef4444";
        } else {
          charCount.style.color = "#555";
        }
      });

      openBtn.onclick = () => {
        panel.classList.add("active");
        overlay.classList.add("active");
        document.body.style.overflow = "hidden";
        loadComments();
      };

      closeBtn.onclick = closePanel;
      overlay.onclick = closePanel;

      function closePanel() {
        panel.classList.remove("active");
        overlay.classList.remove("active");
        document.body.style.overflow = "";
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && panel.classList.contains("active")) {
          closePanel();
        }
      });

      adminInput?.addEventListener("input", () => {
        isAdmin = adminInput.value === "0000";
        loadComments();
      });

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("visible");
        setTimeout(() => {
          errorMessage.classList.remove("visible");
        }, 5000);
      }

      async function loadComments() {
        const currentSlug = document.getElementById("__post_slug")?.dataset.slug;
        if (!currentSlug) return;

        try {
          loadingState.classList.add("visible");
          emptyState.classList.remove("visible");
          commentsList.style.display = "none";

          const res = await fetch(`/api/comments?slug=${encodeURIComponent(currentSlug)}`);
          
          if (!res.ok) {
            throw new Error("Error al cargar comentarios");
          }

          const comments = await res.json();
          const count = comments.length;
          commentCount.textContent = count;

          loadingState.classList.remove("visible");

          if (count === 0) {
            emptyState.classList.add("visible");
            commentsList.style.display = "none";
          } else {
            emptyState.classList.remove("visible");
            commentsList.style.display = "flex";
          }

          commentsList.innerHTML = "";

          comments.forEach((c) => {
            const div = document.createElement("div");
            div.classList.add("comment-item");

            const name = c.author || "An贸nimo";
            const dateStr = new Date(c.created_at).toLocaleString("es-ES", {
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit"
            });

            const nameDiv = document.createElement("div");
            nameDiv.className = "comment-name";
            nameDiv.textContent = name;

            const text = document.createElement("div");
            text.className = "comment-text";
            text.textContent = c.content;

            const dateDiv = document.createElement("div");
            dateDiv.className = "comment-date";
            dateDiv.textContent = dateStr;

            div.appendChild(nameDiv);
            div.appendChild(text);
            div.appendChild(dateDiv);

            if (isAdmin) {
              const deleteBtn = document.createElement("button");
              deleteBtn.className = "delete-btn";
              deleteBtn.setAttribute("data-id", c.id);
              deleteBtn.textContent = " Eliminar";
              div.appendChild(deleteBtn);
            }

            commentsList.appendChild(div);
          });
        } catch (err) {
          console.error("Error loading comments:", err);
          loadingState.classList.remove("visible");
          showError("Error al cargar los comentarios");
        }
      }

      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-btn")) {
          const id = e.target.getAttribute("data-id");

          if (confirm("驴Eliminar este comentario?")) {
            try {
              const res = await fetch("/api/comments", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id }),
              });

              if (!res.ok) {
                throw new Error("Error al eliminar");
              }

              await loadComments();
            } catch (err) {
              console.error("Error deleting comment:", err);
              showError("Error al eliminar el comentario");
            }
          }
        }
      });

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nameInput = document.getElementById("comment-name");
        const contentInput = document.getElementById("comment-content");
        const websiteInput = document.getElementById("comment-website");
        const submitBtn = document.getElementById("submitBtn");

        const name = nameInput?.value.trim() || "An贸nimo";
        const content = contentInput?.value.trim();
        const website = websiteInput?.value.trim();

        if (!content || content.length < 3) {
          showError("El comentario debe tener al menos 3 caracteres");
          return;
        }

        try {
          submitBtn.disabled = true;
          submitBtn.querySelector("span").textContent = "Publicando...";

          const res = await fetch("/api/comments", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              post_slug: document.getElementById("__post_slug")?.dataset.slug,
              author: name,
              content,
              website,
            }),
          });

          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || "Error al publicar");
          }

          contentInput.value = "";
          nameInput.value = "";
          websiteInput.value = "";
          charCount.textContent = "0/1000";

          await loadComments();
        } catch (err) {
          console.error("Error posting comment:", err);
          showError(err.message || "Error al publicar el comentario");
        } finally {
          submitBtn.disabled = false;
          submitBtn.querySelector("span").textContent = "Publicar";
        }
      });
    }

    // Ejecutar al cargar normal
    document.addEventListener("DOMContentLoaded", initCommentsSystem);

    // Ejecutar cuando Astro cambia de p谩gina
    document.addEventListener("astro:page-load", initCommentsSystem);
  </script>

</BaseLayout>